#/bin/bash

. ${TESTDIR}common.sh
set +o errexit


mk_cfg <<EOF
pem-file = "$TESTDIR/certs/default.example.com"
frontend = "[$LISTENADDR]:$LISTENPORT"
backend = "[hitch-tls.org]:80"
EOF

$HITCH $HITCH_ARGS --config=$CONFFILE
test "$?" = "0" || die "Hitch did not start."

runcurl $LISTENADDR $LISTENPORT

mk_cfg <<EOF
pem-file = "$TESTDIR/certs/default.example.com"
frontend = "[$LISTENADDR]:$((LISTENPORT+1))"
backend = "[hitch-tls.org]:80"
EOF

kill -HUP $(cat $PIDFILE)
sleep 1
runcurl $LISTENADDR $((LISTENPORT+1))

curl --silent --insecure https://$LISTENADDR:$((LISTENPORT))/ 2>&1
test "$?" != "0" || die "Removed listen endpoint should not be available."

